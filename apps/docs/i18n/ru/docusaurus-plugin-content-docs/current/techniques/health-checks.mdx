---
sidebar_position: 2
---

# Хелзчеки

```mdx-code-block
import BrowserWindow from '@site/src/components/BrowserWindow';
```

Страница описывает, как отвязать запуск приложения от внешних сервисов (БД, RMQ, Kafka и т. д.)

## Проблема

Представьте себе огромное приложение с кучей внутренних сервисов, перед тобой стоит задача изменить пайп в одном из контроллеров. Pipe не имеет ничего общего с базой данных или Kafka. Чтобы запустить приложение и протестировать пайп, тебе нужно будет запустить базу данных и все внешние службы. Не очень удобно, да?

Как запустить приложение, которое не зависит от базы данных, кафки или каких-то других внутренних сервисов? Как получить статус подключения к сервису из приложения?

## Решение

Не завершай работу приложения, если не удалось подключиться к внутренним службам. Приложение должно работать, даже если оно не подключено к базе данных

> Проверка работоспособности представляет собой сводку индикаторов. Индикатор выполняет проверку службы, независимо от того, находится ли она в исправном или неработоспособном состоянии. Проверка работоспособности является положительной, если все назначенные индикаторы работоспособности включены и работают.

Создай HealthCheckModule с контроллером

```ts title="libs/core/health-checks/src/lib/health-checks.controller.ts"
import { Controller, Get, Logger } from '@nestjs/common';
import { CustomInject } from 'nestjs-custom-injector';
import { HEALTH_CHECKS_PROVIDER } from './health-checks.config';
import { HealthCheckResult } from './interfaces/health-check-result.interface';
import { HealthIndicator } from './interfaces/health-indicator.interface';

@Controller()
export class HealthChecksController {
  private _logger = new Logger(HealthChecksController.name);
  private _appStartedAt: number = Date.now();

  @CustomInject<HealthIndicator>(HEALTH_CHECKS_PROVIDER, {
    multi: true,
  })
  private healthIndicators!: HealthIndicator[];

  @Get('/health')
  async check(): Promise<HealthCheckResult> {
    const timestamp = Date.now();
    const uptime = Math.floor((timestamp - this._appStartedAt) / 1000);

    const services = await Promise.all(
      this.healthIndicators.map(
        async (indicator) => await indicator.isHealthy()
      )
    );

    const successfulServices = services.filter((s) => s.status === 'up').length;
    const ratio = +(successfulServices / services.length).toFixed(2);

    return {
      ratio,
      uptime,
      timestamp,
      services,
    };
  }
}
```

Затем лови ошибку подключения ORM или транспортного сервиса. В качестве примера я использую клиент Prisma.

```ts title="libs/core/prisma-client/src/lib/prisma-client.service.ts"
async onModuleInit(): Promise<void> {
    try {
        // connect to the database
        await this.$connect()
    } catch (err) {
        // do not throw error here
        this.logger.error(err, err.stack)
    }
}
```

Создай Prisma Health Indicator

```ts title="libs/core/prisma-client/src/lib/prisma-client-connection.health.ts"
import { Injectable } from '@nestjs/common';
import { HealthIndicator, HealthIndicatorResult } from '@nx/core/health-checks';
import { PrismaClientService } from './prisma-client.service';

@Injectable()
export class PrismaClientConnectionHealthIndicator implements HealthIndicator {
  name = 'database';

  constructor(private readonly prismaClientService: PrismaClientService) {}

  async isHealthy(): Promise<HealthIndicatorResult> {
    try {
      await this.prismaClientService.$queryRaw<
        { dt: string }[]
      >`SELECT now() dt`;

      // drop here everything you want
      return {
        name: this.name,
        status: 'up',
      };
    } catch (error) {
      return {
        name: this.name,
        status: 'down',
        error: error.message,
      };
    }
  }
}
```

И как результат

````mdx-code-block
<BrowserWindow url="http://localhost:3000/api/health" minHeight={240}>

```json
{
  "ratio": 1,
  "uptime": 5,
  "timestamp": 1675597500626,
  "services": [
    {
      "name": "database",
      "status": "up",
    },
    {
      "name": "my-service",
      "status": "up",
      "details": {
        "entitiesCreated": 500
      }
    }
  ]
}
````

</BrowserWindow>

С ошибкой подключения к БД, приложение продолжает запускаться

![image](./img/hc-log.png)

:::tip

Чекай полный пример [здесь](https://github.com/temarusanov/nx/tree/master/libs/core/health-checks/src/lib)

:::
